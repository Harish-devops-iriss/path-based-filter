name: Backend Dev V2 Workflow

on:
  push:
    branches: [ main ]
    paths:
      - "src/**"
      - "infrastructure/**"
      
permissions:
  id-token: write
  contents: write
  pull-requests: write

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      infrastructure: ${{ steps.filter.outputs.infrastructure }}
      application: ${{ steps.filter.outputs.application }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect path changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            infrastructure:
              - "infrastructure/**"
            application:
              - "src/**"

  deploy_infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    environment: Development
    needs: changes
    if: needs.changes.outputs.infrastructure == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Notify start (Infrastructure)
        run: echo "Infrastructure deployment started"

      # --- DEPLOY INFRASTRUCTURE HERE ---
      - name: Deploy (placeholder)
        run: echo "Running infra deployment..."

  build_application:
    name: Build Application
    runs-on: ubuntu-latest
    environment: Development
    needs: changes
    if: needs.changes.outputs.application == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Notify start (Application)
        run: echo "Application build started"

      # --- BUILD APP HERE ---
      - name: Build (placeholder)
        run: echo "Building application..."

  deploy_application:
    name: Deploy Application
    runs-on: ubuntu-latest
    environment: Development
    needs:
      - changes
      - build_application
    if: needs.changes.outputs.application == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Notify start (Application Deploy)
        run: echo "Application deploy started"

      # --- DEPLOY APP HERE ---
      - name: Deploy (placeholder)
        run: echo "Deploying application..."

  notify_pr:
    name: Notify PR via GitHub
    runs-on: ubuntu-latest
    needs:
      - changes
      - deploy_infrastructure
      - build_application
      - deploy_application
    if: always()
    steps:
      - name: Comment on associated PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const infraResult = '${{ needs.deploy_infrastructure.result || 'skipped' }}';
            const buildResult = '${{ needs.build_application.result || 'skipped' }}';
            const appResult = '${{ needs.deploy_application.result || 'skipped' }}';
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            const sha = process.env.GITHUB_SHA ? process.env.GITHUB_SHA.slice(0,7) : '';
            const body = [
              `Repo: ${context.repo.owner}/${context.repo.repo}`,
              `Ref: ${context.ref} (${sha})`,
              `Deploy Infrastructure: ${infraResult}`,
              `Build Application: ${buildResult}`,
              `Deploy Application: ${appResult}`,
              `Run: ${runUrl}`
            ].join('\n');

            const {data: prs} = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: process.env.GITHUB_SHA,
            });

            if (!prs.length) {
              core.info('No PR found for this commit; skipping PR notification.');
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prs[0].number,
              body,
            });
