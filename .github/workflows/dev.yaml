## New Development workflow structure for Backend infra and application deployment.
name: Backend Dev V2 Workflow

on:
  push:
    branches: [ main ]
    paths:c
      - 'src/**'
      - 'infrastructure/**'

jobs:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      infrastructure: ${{ steps.filter.outputs.infrastructure }}
      application: ${{ steps.filter.outputs.application }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect path changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            infrastructure:
              - 'infrastructure/**'
            application:
              - 'src/**'

  deploy_infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    environment: Development
    needs: changes
    if: needs.changes.outputs.infrastructure == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Notify start (Infrastructure)
        run: |
         echo "Infrastructure deployment started"

      
        if: failure()
        env:
          TEAMS_WEBHOOK_URL: ${{ env.TEAMS_WEBHOOK_URL }}
          DEPLOYMENT_STAGE: Infrastructure
          STATUS: Failed
          STATUS_COLOR: 'BB2200'
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          if [ -z "$TEAMS_WEBHOOK_URL" ]; then exit 0; fi
          payload=$(jq -n \
            --arg stage "$DEPLOYMENT_STAGE" \
            --arg status "$STATUS" \
            --arg env "$DEPLOYMENT_ENVIRONMENT" \
            --arg branch "$GITHUB_REF_NAME" \
            --arg sha "$GITHUB_SHA" \
            --arg message "$COMMIT_MESSAGE" \
            --arg actor "$GITHUB_ACTOR" \
            --arg color "$STATUS_COLOR" \
            '{
              "@type": "MessageCard",
              "@context": "http://schema.org/extensions",
              "summary": "\($stage) deployment \($status)",
              "themeColor": $color,
              "sections": [
                {
                  "activityTitle": "cicd-build-pipeline - ESentry Devs | \($stage) \($status)",
                  "activitySubtitle": "Environment: \($env)",
                  "facts": [
                    {"name": "Branch", "value": $branch},
                    {"name": "Commit", "value": $sha},
                    {"name": "Commit Message", "value": $message},
                    {"name": "Actor", "value": $actor}
                  ]
                }
              ]
            }')
          curl -X POST -H "Content-Type: application/json" -d "$payload" "$TEAMS_WEBHOOK_URL"

  build_application:
    name: Build Application
    runs-on: ubuntu-latest
    environment: Development
    needs:
      - changes
      - deploy_infrastructure
    if: >
      needs.changes.outputs.application == 'true' &&
      (needs.deploy_infrastructure.result == 'success' || needs.deploy_infrastructure.result == 'skipped')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
    
      - name: Notify start (Application)
        run: |
         echo "Application build started"

     